digraph KL_Clustering_Algorithm {
    rankdir=TB; // Top to bottom
    node [shape=box, style=filled, color=lightblue];

    Start [label="Start / Read Input"];
    KL_Partition [label="Initial KL Partition"];
    Cluster [label="Cluster Nodes in Each Partition"];
    Compute_Var [label="Compute Variance of Clusters"];
    KL_Gain [label="Compute KL Gains for Cluster Pairs"];
    Select_Best [label="Select Best Cluster Pair to Swap"];
    Swap [label="Swap Clusters"];
    Lock_Clusters [label="Lock Swapped Clusters"];
    Update_Cut [label="Update Cut Trace"];
    More_Pairs [label="More Cluster Pairs to Swap?", shape=diamond, style=filled, color=lightyellow];
    Rollback [label="Rollback to Best Prefix of Swaps"];
    Output [label="Write Results (Partition, Metrics, Trace)"];
    End [label="End"];

    // Flow edges
    Start -> KL_Partition -> Cluster -> Compute_Var -> KL_Gain -> Select_Best -> Swap -> Lock_Clusters -> Update_Cut -> More_Pairs;
    
    More_Pairs -> KL_Gain [label="Yes"];
    More_Pairs -> Rollback [label="No"];
    
    Rollback -> Output -> End;
}
